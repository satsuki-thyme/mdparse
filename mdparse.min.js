function mdparse(e,t){function n(e){let t=[],n=[],l=0,s=0;return new Promise(r=>{function a(){t[s]={};let c=e[s].match(/^(?:\t| {4})+/);if(t[s].indent=null===c?0:c[0].match(/\t| {4}/g).length,!1===m&&!0===/^$/.test(e[s]))t[s].class="blank",s<e.length-1?(s++,a()):r([e,t,n]);else if(!1===m&&!0===/^#{1,6} /.test(e[s]))t[s].class="h",s<e.length-1?(s++,a()):r([e,t,n]);else if(!1===m&&!1===/^(#{1,6}|\* |\+ |- |\d+\. |( {4,}|\t)(?!\\)|```|~~~|>+ |\||\[\^.+?\]: ?).*$|^[ \t]*(?!\\)([*\-_][ \t]*){3,}$/.test(e[s]))t[s].class="p",s<e.length-1?(s++,a()):r([e,t,n]);else if(!1===m&&!0===/^(\t| {4})*[*+\-] (?!\[[ x]\] )/.test(e[s])&&(0===s&&0===t[s].indent||s>0&&("li"===t[s-1].class&&t[s].indent-t[s-1].indent<=1||"li"!==t[s-1].class&&0===t[s].indent)))t[s].class="li",t[s].parent="ul",t[s].task=!1,s<e.length-1?(s++,a()):r([e,t,n]);else if(!1===m&&!0===/^(\t| {4})*\d+\. /.test(e[s])&&(0===s&&0===t[s].indent||s>0&&("li"===t[s-1].class&&t[s].indent-t[s-1].indent<=1||"li"!==t[s-1].class&&0===t[s].indent)))t[s].class="li",t[s].parent="ol",t[s].task=!1,s<e.length-1?(s++,a()):r([e,t,n]);else if(!1===m&&!0===/^(\t| {4})*[*+\-] \[[ x]\] /.test(e[s])&&(0===s&&0===t[s].indent||s>0&&("li"===t[s-1].class&&t[s].indent-t[s-1].indent<=1||"li"!==t[s-1].class&&0===t[s].indent)))t[s].class="li",t[s].parent="ul",t[s].task=!0,s<e.length-1?(s++,a()):r([e,t,n]);else if(!1===m&&!0===/^>+ /.test(e[s]))t[s].class="bq",t[s].stack=e[s].match(/^>+/)[0].match(/>/g).length,s<e.length-1?(s++,a()):r([e,t,n]);else if(!0===/^```|^~~~/.test(e[s]))t[s].class="preEncl",t[s].site="end",!1===m?(m=!0,t[s].preGrp=s):m=!1,s<e.length-1?(s++,a()):r([e,t,n]);else if(!0===m&&!1===/^```|^~~~/.test(e[s]))t[s].class="preEncl",t[s].site="middle",t[s].preGrp=t[s-1].preGrp,s<e.length-1?(s++,a()):r([e,t,n]);else if(!1===m&&!0===/^(\t| {4})+(?!([*\-_][ \t]*){3,}$)/.test(e[s])&&(!1===/^(\*|\+|-|\d+\.) /.test(e[s])||s!==t.length-1&&"li"!==t[s-1]))t[s].class="preInd",s<e.length-1?(s++,a()):r([e,t,n]);else if(!1===m&&!0===/^\|/.test(e[s])){t[s].class="table";let c=!1;if(!0===/^(\| ?:?-+:? ?)+\|/.test(e[s])&&(c=!0),s>0&&"table"===t[s-1].class?(t[s].tableGrp=t[s-1].tableGrp,!1===c&&(l++,t[s].rowNum=l)):(n.push({}),t[s].tableGrp=n.length-1,n[t[s].tableGrp].hLineAlready=!1,n[t[s].tableGrp].hLinePosition=0,!1===c&&(l=0,t[s].rowNum=0)),!1===c)t[s].hLine=!1;else if(t[s].hLine=!0,!1===n[t[s].tableGrp].hLineAlready){n[t[s].tableGrp].hLineAlready=!0;let l=b(e[s]);n[t[s].tableGrp].align=`class="user-cnt-table-${l}" align="${l}"`,0===s||"table"!==t[s-1].class?n[t[s].tableGrp].hLinePosition=0:n[t[s].tableGrp].hLinePosition=t[s-1].rowNum+1}s<e.length-1?(s++,a()):r([e,t,n])}else!1===m&&!0===/\[.+?\]: /.test(e[s])?(t[s].class="footnote",s<e.length-1?(s++,a()):r([e,t,n])):!1===m&&!0===/^[ \t]*(?!\\)([*\-_][ \t]*){3,}$/.test(e[s])?(t[s].class="hr",s<e.length-1?(s++,a()):r([e,t,n])):(t[s].class="unmatched",s<e.length-1?(s++,a()):r([e,t,n]))}a()})}function l(e){let t=e[0],n=e[1];for(let e in n)"preEncl"!==n[e].class&&"preInd"!==n[e].class||(t[e]=t[e].replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/â€œ/g,"&quot;").replace(/ /g,"&nbsp;"));return[t,n,e[2]]}function s(e){let n=e[0],l=e[1],s=e[2],r=0;return!0===m&&(n.push("```"),l.push({class:"preEncl",site:"end"})),new Promise(e=>{function a(){"blank"===l[r].class?r<l.length-1?(r++,a()):e([n,l]):"h"===l[r].class?(n[r]=c(n,r),r<l.length-1?(r++,a()):e([n,l])):"p"===l[r].class?r===l.length-1||"p"!==l[r+1].class||"permissive"===t?(n[r]=`<p>${n[r]}</p>`,r<l.length-1?(r++,a()):e([n,l])):(n[r+1]=`${n[r]}${i(n[r])}${n[r+1]}`,n=n.slice(0,r).concat(n.slice(r+1)),l=l.slice(0,r).concat(l.slice(r+1)),r<l.length-1?a():e([n,l])):"li"===l[r].class?(n[r]=p(n,l,r),r<l.length-1?(r++,a()):e([n,l])):"bq"===l[r].class?(n[r]=d(n,l,r),r<l.length-1?(r++,a()):e([n,l])):"preEncl"===l[r].class?"middle"===l[r].site?u(n,l,r).then(t=>{n[r]=t,r<l.length-1?(r++,a()):e([n,l])}):(n=n.slice(0,r).concat(n.slice(r+1)),l=l.slice(0,r).concat(l.slice(r+1)),r<l.length-1?a():e([n,l])):"preInd"===l[r].class?(n[r]=g(n,l,r),r<l.length-1?(r++,a()):e([n,l])):"table"===l[r].class?!1===l[r].hLine?$(n,l,s,r).then(t=>{n[r]=t,r<l.length-1?(r++,a()):e([n,l])}):(n=n.slice(0,r).concat(n.slice(r+1)),l=l.slice(0,r).concat(l.slice(r+1)),r<l.length-1?a():e([n,l])):"footnote"===l[r].class?(G.push({key:n[r].match(/(?<=\[\^).+?(?=\]: )/)[0],word:n[r].replace(/\[\^.+?\]: /,"")}),n=n.slice(0,r).concat(n.slice(r+1)),l=l.slice(0,r).concat(l.slice(r+1)),r<l.length-1?a():e([n,l])):"hr"===l[r].class?(n[r]="<hr>",r<l.length-1?(r++,a()):e([n,l])):"unmatched"===l[r].class&&(console.log(`unmatched at line ${r}\n${n[r]}`),r<l.length-1?(r++,a()):e([n,l]))}a()})}function r(e){return e[0].filter(e=>0!==e.length).map(e=>e.replace(/(?<!\\|_)_(?!_|.*<br>)(.+?)(?<!_)_(?!_)/g,"<em>$1</em>").replace(/(?<!\\|_)__(?!_|.*<br>)(.+?)(?<!_)__(?!_)/g,"<strong>$1</strong>").replace(/(?<!\\)___(?!.*<br>)(.+?)___/g,"<strong><em>$1</em></strong>").replace(/(?<!\\|\*)\*(?!\*|.*<br>)(.+?)(?<!\*)\*(?!\*)/g,"<em>$1</em>").replace(/(?<!\\|\*)\*\*(?!\*|.*<br>)(.+?)(?<!\*)\*\*(?!\*)/g,"<strong>$1</strong>").replace(/(?<!\\)\*\*\*((?!.*<br>).+?)\*\*\*/g,"<strong><em>$1</em></strong>").replace(/(?<!\\|~)~~(?!~|.*<br>)(.+?)(?<!~)~~(?!~)/g,"<del>$1</del>").replace(/(?<!\\)`(?!.*<br>)(.+)`/g,"<code>$1</code>").replace(/(?<!\\|!)\[(?!.*<br>)(.+?)(?<!\])\]\((.+?)\)/g,'<a href="$2">$1</a>').replace(/(?<!\\)!\[(?!.*<br>)(.+?)(?<!\])\]\((.+?)\)/g,'<img src="$2" alt="$1">').replace(/(?<!\\)\\(.)/g,"$1"))}function a(e){function t(e){let t=e;for(let e=0;e<c.length;e++){let n=new RegExp(`\\[\\^${c[e]}\\]`);for(let l=0;l<o.length;l++)c[e]===o[l]&&(t=t.replace(n,`<sup>[<a id="user-cnt-funref-${e}" href="#user-cnt-fun-${l}">${l+1}</a>]</sup>`))}return t}function n(){let e=[];for(let t in i)for(let n=0;n<G.length;n++)i[t]===G[n].key&&(e.push(G[n]),G=G.slice(0,n).concat(G.slice(n+1)));for(let t in G)e.push(G[t]);return e}function l(e){let t=[],n=e.match(/\[\^.+?\]/g);if(null!==n)for(let e in n)t.push(n[e].replace(/\[\^|\]/g,""));return t}function s(){let e=[];for(let t in p)e.push(`<li id="user-cnt-fun-${t}"><p>${p[t].word.replace(/^\[[^\]]+\]: /g,"")}${h[t].join("")}</p></li>`);return e.join("")}function r(){let e=[];for(let t in p){e[t]=[];for(let n in c)p[t].key===c[n]&&e[t].push(` <a href="#user-cnt-funref-${n}">${w}</a>`)}return e}let a=e.join(""),c=l(a),i=Array.from(new Set(c)),p=n(),o=[];for(let e in p)o.push(p[e].key);o=Array.from(new Set(o));let h=r(),d=t(a),u=s();return""===u||0===c.length?d:`${d}<section class="footnotes"><ol>${u}</ol></section>`}function c(e,t){let n=e[t].match(/^#+/)[0].match(/#/g).length;return`<h${n}>${e[t].replace(/^#+ /,"")}</h${n}>`}function i(e){return!1===/<br>$/.test(e)?" ":""}function p(e,t,n){return n>0&&n<t.length-1&&"li"===t[n-1].class&&(t[n].indent<t[n-1].indent||t[n].indent===t[n-1].indent&&t[n].parent===t[n-1].parent)&&"li"===t[n+1].class&&(t[n].indent<t[n+1].indent||t[n].indent===t[n+1].indent&&t[n].parent===t[n+1].parent)?`${o(e,t,n)}${e[n].replace(/^[\t ]*([*+\-]|\d+\.) (\[[ x]\] )?/,"")}</li>`:(0===n||"li"!==t[n-1].class||t[n].indent>t[n-1].indent||t[n].indent===t[n-1].indent&&t[n].parent!==t[n-1].parent||t[n].indent<t[n-1].indent&&t[n].parent!==k[k.length-1])&&n<t.length-1&&"li"===t[n+1].class&&(t[n].indent<t[n+1].indent||t[n].indent===t[n+1].indent&&t[n].parent===t[n+1].parent)?(k.push(t[n].parent),`<${t[n].parent}>${o(e,t,n)}${e[n].replace(/^[\t ]*([*+\-]|\d+\.) (\[[ x]\] )?/,"")}</li>`):(n===t.length-1||"li"!==t[n+1].class||t[n].indent>t[n+1].indent||t[n].indent===t[n+1].indent&&t[n].parent!==t[n+1].parent)&&0!==n&&"li"===t[n-1].class&&(t[n].indent<t[n-1].indent&&t[n].parent===k[k.length-1]||t[n].indent===t[n-1].indent&&t[n].parent===t[n-1].parent)?`${o(e,t,n)}${e[n].replace(/^[\t ]*([*+\-]|\d+\.) (\[[ x]\] )?/,"")}</li>${h(t,n)}`:(0===n||"li"!==t[n-1].class||t[n].indent>t[n-1].indent||t[n].indent===t[n-1].indent&&t[n].parent!==t[n-1].parent||t[n].indent<t[n-1].indent&&t[n].parent!==k[k.length-1])&&(n===t.length-1||"li"!==t[n+1].class||t[n].indent>t[n+1].indent||t[n].indent===t[n+1].indent&&t[n].parent!==t[n+1].parent)?(k.push(t[n].parent),`<${t[n].parent}>${o(e,t,n)}${e[n].replace(/^[\t ]*([*+\-]|\d+\.) (\[[ x]\] )?/,"")}</li>${h(t,n)}`):void 0}function o(e,t,n){return!1===t[n].task?"<li>":!0===/^.*\[ \]/.test(e[n])?'<li class="user-cnt-tasklist"><input type="checkbox"> ':'<li class="user-cnt-tasklist"><input type="checkbox" checked> '}function h(e,t){let n="";if(t===e.length-1||"li"!==e[t+1].class||0===e[t+1].indent&&e[t+1].parent!==k[0])return n=`</${k.reverse().join("></")}>`,k=[],n;if(t<e.length-1&&"li"===e[t+1].class&&e[t].indent>e[t+1].indent){let l=e[t+1].indent-e[t].indent;return n=`</${k.slice(l).reverse().join("></")}>`,k=k.slice(0,k.length+l),n}return t<e.length-1&&"li"===e[t+1].class&&e[t].indent===e[t+1].indent&&0!==e[t+1].indent&&e[t].parent!==e[t+1].parent?(n=`</${k.slice(-1)}>`,k=k.slice(0,k.length-1),n):void 0}function d(e,t,n){if(n>0&&n<t.length-1&&t[n].stack<=t[n-1].stack&&t[n].stack<=t[n+1].stack)return e[n].replace(/^>+ /,"");if((0===n||"bq"!==t[n-1].class||t[n].stack>t[n-1].stack)&&n<t.length-1&&"bq"===t[n+1].class){let l="";return l="bq"!==t[n-1].class?`${"<blockquote>".repeat(t[n].stack)}<p>`:`${"<blockquote>".repeat(t[n].stack-t[n-1].stack)}<p>`,`${l}${e[n].replace(/^>+ /,"")}`}if((n===t.length-1||"bq"!==t[n+1].class||t[n].stack>t[n+1].stack)&&n>0&&"bq"===t[n-1].class){let l="";return l="bq"!==t[n+1].class?`${"</blockquote>".repeat(t[n].stack)}</p>`:`${"</blockquote>".repeat(t[n].stack-t[n+1].stack)}</p>`,`${e[n].replace(/^>+ /,"")}${l}`}if((0===n||"bq"!==t[n-1].class||t[n].stack>t[n-1].stack)&&(n===t.length-1||"bq"!==t[n+1].class||t[n].stack>t[n+1].stack)){let l="",s="";return l="bq"!==t[n-1].class?`${"<blockquote>".repeat(t[n].stack)}<p>`:`${"<blockquote>".repeat(t[n].stack-t[n-1].stack)}<p>`,s="bq"!==t[n+1].class?`${"</blockquote>".repeat(t[n].stack)}</p>`:`${"</blockquote>".repeat(t[n].stack-t[n+1].stack)}</p>`,`${l}${e[n].replace(/^>+ /,"")}${s}`}}async function u(e,t,n){return n>0&&"preEncl"===t[n-1].class&&t[n-1].preGrp===t[n].preGrp&&n<t.length-1&&"preEncl"===t[n+1].class&&t[n+1].preGrp===t[n].preGrp?`\n${e[n]}`:(0===n||"preEncl"!==t[n-1].class||t[n-1].preGrp!==t[n].preGrp)&&n<t.length-1&&"preEncl"===t[n+1].class&&t[n+1].preGrp===t[n].preGrp?`<pre><code>${e[n]}`:(n===t.length-1||"preEncl"!==t[n+1].class||t[n+1].preGrp!==t[n].preGrp)&&n>0&&"preEncl"===t[n-1].class&&t[n-1].preGrp===t[n].preGrp?`\n${e[n]}</code></pre>`:0!==n&&"preEncl"===t[n-1].class&&t[n-1].preGrp===t[n].preGrp||n!==t.length-1&&"preEncl"===t[n+1].class&&t[n+1].preGrp===t[n].preGrp?void 0:`<pre><code>${e[n]}</code></pre>`}function g(e,t,n){return n>0&&"preInd"===t[n-1].class&&n<t.length-1&&"preInd"===t[n+1].class?`\n${e[n].replace(/^\t|^ {4}/,"")}`:0===n||"preInd"!==t[n-1].class&&n<t.length-1&&"preInd"===t[n+1].class?`<pre><code>${e[n].replace(/^\t|^ {4}/,"")}`:n===t.length-1||"preInd"!==t[n+1].class&&n>0&&"preInd"===t[n-1].class?`\n${e[n].replace(/^\t|^ {4}/,"")}</code></pre>`:0!==n&&"preInd"===t[n-1].class||n!==t.length-1&&"preInd"===t[n+1].class?void 0:`<pre><code>${e[n].replace(/^\t|^ {4}/,"")}</code></pre>`}async function $(e,t,n,l){if(l>0&&"table"===t[l-1].class&&l<t.length-1&&"table"===t[l+1].class){if(n[t[l].tableGrp].hLinePosition===t[l].rowNum+1)return`${f(e,t,n,l)}</thead>`;if(n[t[l].tableGrp].hLinePosition===t[l].rowNum)return`<tbody>${f(e,t,n,l)}`;if(n[t[l].tableGrp].hLinePosition!==t[l].rowNum+1&&n[t[l].tableGrp].hLinePosition!==t[l].rowNum)return`${f(e,t,n,l)}`}if((0===l||"table"!==t[l-1].class)&&l<t.length&&"table"===t[l+1].class){if(0===n[t[l].tableGrp].hLinePosition)return`<table><tbody>${f(e,t,n,l)}`;if(1===n[t[l].tableGrp].hLinePosition)return`<table><thead>${f(e,t,n,l)}</thead>`;if(n[t[l].tableGrp].hLinePosition>1)return`<table><thead>${f(e,t,n,l)}`}if((l===t.length-1||"table"!==t[l+1].class)&&l>0&&"table"===t[l-1].class){if(n[t[l].tableGrp].hLinePosition===t[l].rowNum+1)return`${f(e,t,n,l)}</thead></table>`;if(n[t[l].tableGrp].hLinePosition===t[l].rowNum)return`<tbody>${f(e,t,n,l)}</tbody></table>`;if(n[t[l].tableGrp].hLinePosition!==t[l].rowNum+1&&n[t[l].tableGrp].hLinePosition!==t[l].rowNum)return`${f(e,t,n,l)}</tbody></table>`}if(!(0!==l&&"table"===t[l-1].class||l!==t.length-1&&"table"===t[l+1].class)){if(n[t[l].tableGrp].hLinePosition===l-t[l].tableGrp+1)return`<table><thead>${f(e,t,n,l)}</thead></table>`;if(n[t[l].tableGrp].hLinePosition===l-t[l].tableGrp)return`<table><tbody>${f(e,t,n,l)}</tbody></table>`}}function b(e){let t=e.split("|");return t.splice(1,t.length-2).map(e=>!0===/^ ?:-+ ?$/.test(e)?"left":!0===/^ ?:-+: ?$/.test(e)?"center":!0===/^ ?-+: ?$/.test(e)?"right":!0===/^ ?-+ ?$/.test(e)?"":void 0)}function f(e,t,n,l){let s=e[l].split(/[ \t]*(?<!\\)\|[ \t]*/);return"<tr>"+s.splice(1,s.length-2).map((e,s)=>`<td ${n[t[l].tableGrp].align[s]}>${e}</td>`).join("")+"</tr>"}let k=[],m=!1,G=[],w='<svg class="user-cnt-arrow" version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0, 0, 16, 21"><path d="M 0,0 V 2 h 8 c 3,0 6,3 6,6 0,3 -3,6 -6,6 H 7 v 2 h 1 c 4,0 8,-4 8,-8 0,-4 -4,-8 -8,-8 z"/><path d="M 6,21 7,19 3,15 7,11 6,9 0,15 Z"/></svg>';return n(e.replace(/  $/gm,"<br>").split(/\r?\n/)).then(e=>l(e)).then(e=>s(e)).then(e=>r(e)).then(e=>a(e))}